#!/bin/bash

#
# Shell script to launch Java app ${config.name}
#
# Auto generated by mfz-jtools-launcher.
#  Web: http://mfizz.com
#  Twitter: http://twitter.com/mfizz_inc
#

#
# settings
#

# min and max mem (in MB); leave empty for java defaults
JAVA_MIN_MEM="${config.minJavaMemory!""}"
JAVA_MAX_MEM="${config.maxJavaMemory!""}"

# min and max mem as a percent of system memory
# they have priority over JAVA_MIN_MEM and JAVA_MAX_MEM if set
JAVA_MIN_MEM_PCT="${config.minJavaMemoryPct!""}"
JAVA_MAX_MEM_PCT="${config.maxJavaMemoryPct!""}"

# application run dir (e.g. for pid file)
RUN_DIR="${config.runDir!""}"

# application log dir (e.g. for [name.out] file)
LOG_DIR="${config.logDir!""}"

#
# constants
#

NAME="${config.name}"
TYPE="${config.type}"
MAIN_CLASS="${config.mainClass}"
WORKING_DIR_MODE="${config.workingDirMode}"
APP_ARGS="${config.appArgs}"
JAVA_ARGS="${config.javaArgs}"
JAR_DIR="${config.jarDir}"
MIN_JAVA_VERSION="${config.minJavaVersion}"

#
# working directory
#

# save current working directory
INITIAL_WORKING_DIR="`pwd`"

# change working directory to app home
cd $(dirname $0)/..

# application home is now current directory
APP_HOME="`pwd`"

# revert to initial working directory?
if [ $WORKING_DIR_MODE == "RETAIN" ]; then
  cd "$INITIAL_WORKING_DIR"
fi


#
# is run directory absolute or relative to app home?
#
if [[ "$RUN_DIR" == /* ]]; then
    # absolute path
    APP_RUN_DIR="$RUN_DIR"
    APP_RUN_DIR_DEBUG="$RUN_DIR"
else
    if [ $WORKING_DIR_MODE == "RETAIN" ]; then
        # relative path to app home (but use absolute version)
        APP_RUN_DIR="$APP_HOME/$RUN_DIR"
    else
        # relative path to app home (use relative version)
        APP_RUN_DIR="$RUN_DIR"
    fi
    APP_RUN_DIR_DEBUG="<app_home>/$RUN_DIR"
fi


#
# is log directory absolute or relative to app home?
#
if [[ "$LOG_DIR" == /* ]]; then
    # absolute path
    APP_LOG_DIR="$LOG_DIR"
    APP_LOG_DIR_DEBUG="$LOG_DIR"
else
    if [ $WORKING_DIR_MODE == "RETAIN" ]; then
        # relative path to app home (but use absolute version)
        APP_LOG_DIR="$APP_HOME/$LOG_DIR"
    else
        # relative path to app home (use relative version)
        APP_LOG_DIR="$LOG_DIR"
    fi
    APP_LOG_DIR_DEBUG="<app_home>/$LOG_DIR"
fi


#
# pid handling
#
APP_PID_FILE="$APP_RUN_DIR/$NAME.pid"

#
# do we need verify that the run directory is writable?
#

# will a pid file be used?
if [ "$TYPE" == "DAEMON" ]; then
    if [ ! -d $APP_RUN_DIR ]; then 
        mkdir -p "$APP_RUN_DIR"
    fi
    if [ ! -w $APP_RUN_DIR ]; then
        echo "Error: run directory is not writable by app! [run_dir=$APP_RUN_DIR]"
        exit 1
    fi
fi